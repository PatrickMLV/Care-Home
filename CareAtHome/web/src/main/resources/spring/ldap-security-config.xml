<?xml version="1.0" encoding="UTF-8"?>
<beans:beans xmlns="http://www.springframework.org/schema/security"
        xmlns:beans="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:context="http://www.springframework.org/schema/context"
        xmlns:util="http://www.springframework.org/schema/util"
        xsi:schemaLocation="
                        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
                        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-2.5.xsd
                        http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-2.5.xsd
                        http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-2.0.xsd">


        <global-method-security jsr250-annotations="enabled" />

        <http auto-config="true" access-denied-page="/accessDenied.faces">

                <intercept-url pattern="/index.html" filters="none" />
                <intercept-url pattern="/favicon.ico" filters="none" />
                <intercept-url pattern="/error.faces" filters="none" />
                <intercept-url pattern="/accessDenied.faces" filters="none" />
                <intercept-url pattern="/logout.action" access="ROLE_LDAP" />
                <intercept-url pattern="/login.faces" filters="none" />
                <intercept-url pattern="/resources/**" filters="none" />
                <intercept-url pattern="/css/**" filters="none" />
                <intercept-url pattern="/js/**" filters="none" />
                <intercept-url pattern="/img/**" filters="none" />
                <intercept-url pattern="/flow/a4j/**" filters="none" />

                <intercept-url pattern="/**/student" access="ROLE_LDAP_STUDENT" />
                <intercept-url pattern="/**/teacher" access="ROLE_LDAP_TEACHER" />

                <intercept-url pattern="/**" access="ROLE_LDAP_STUDENT, ROLE_LDAP_TEACHER" />

                <form-login login-page="/login.faces" login-processing-url="/j_spring_security_check"
                        default-target-url="/welcome.faces" authentication-failure-url="/login.faces?login_error=1"
                        always-use-default-target="true" />

                <logout logout-url="/logout.action" logout-success-url="/index.html"
                        invalidate-session="true" />

                <!-- Limits the number of concurent sessions a user can have -->
                <concurrent-session-control max-sessions="2" exception-if-maximum-exceeded="false" />
        </http>

        <beans:bean id="ldapPropertyConfigurer"
                class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
                <beans:property name="properties" ref="paramsLdapFactory" />
                <beans:property name="ignoreUnresolvablePlaceholders" value="true" />
        </beans:bean>
   
        <beans:bean id="paramsLdapFactory"
                class="org.springframework.beans.factory.config.PropertiesFactoryBean">
                <beans:property name="location" value="classpath:ldap.properties" />
        </beans:bean>

        <ldap-server id="ldapServer" url="${ldap.url}" manager-dn="${ldap.admin.cn}"
                manager-password="${ldap.admin.password}" />

        <beans:bean
                class="org.springframework.security.providers.ldap.LdapAuthenticationProvider">
                <custom-authentication-provider />
                <beans:constructor-arg>
                        <beans:bean
                                class="org.springframework.security.providers.ldap.authenticator.BindAuthenticator">
                                <beans:constructor-arg ref="ldapServer" />
                                <beans:property name="userSearch">
                                        <beans:bean
                                                class="org.springframework.security.ldap.search.FilterBasedLdapUserSearch">
                                                <beans:constructor-arg>
                                                        <beans:value>${ldap.searchbase}</beans:value>
                                                </beans:constructor-arg>
                                                <beans:constructor-arg>
                                                        <beans:value>uid={0}</beans:value>
                                                </beans:constructor-arg>
                                                <beans:constructor-arg ref="ldapServer" />
                                                <beans:property name="searchSubtree">
                                                        <beans:value>true</beans:value>
                                                </beans:property>
                                        </beans:bean>
                                </beans:property>
                        </beans:bean>
                </beans:constructor-arg>
                <beans:constructor-arg>
                        <beans:bean
                                class="fr.umlv.m2.jee.ldap.web.utils.MappingLdapSampleLdapAuthoritiesPopulator">
                                <beans:constructor-arg>
                                        <util:properties location="classpath:/ldap_roles_mapping.properties" />
                                </beans:constructor-arg>
                        </beans:bean>
                </beans:constructor-arg>
        </beans:bean>

        <ldap-user-service id="ldapUserDetailsService"
                server-ref="ldapServer" user-search-filter="uid={0}" />

</beans:beans>
